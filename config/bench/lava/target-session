#!/bin/bash
set -uex
set -o pipefail

#Exit cleanly - gather up what we can and let LAVA take over
function errorexit {
  exit 1
}

function quit {
  echo "Received SIGTERM, will exit with error" >&2
  trap errorexit EXIT
  cat /root/post-{target,run,run-finished} | xargs kill
}
trap quit TERM

lava-network broadcast eth0
lava-send "config_`lava-self`" "config=${1}"
lava-send "lava_target_pid_`lava-self`" "lava_target_pid=${BASHPID}"

sleep infinity&
echo $! > /root/post-target
sleep infinity&
echo $! > /root/post-run

wait `cat /root/post-run` && false
if test $? -eq 143; then true; else false; fi

#We must run the gather script here for lava commands (lava-test-run-attach,
#lava-test-case) to work correctly.
if test -e "${HOME}"/gather.sh; then
  if ! test -e "${HOME}"/resultsdir; then
    echo "No resultsdir given" >&2
    exit 1
  fi
  "${HOME}"/gather.sh `cat "${HOME}"/resultsdir`
  echo $? > "${HOME}"/gatherresult
else #Act as though we succeeded if there was nothing to do
  echo 0 > "${HOME}"/gatherresult
fi
test x"`cat /root/post-run-finished`" != x
kill `cat /root/post-run-finished`

wait `cat /root/post-target` && false
if test $? -eq 143; then true; else false; fi

exit 0
